const searchBtn=document.querySelector("#search-btn");const searchIpt=document.querySelector("#search-input");const searchResult=document.querySelector("#search-result");const searchClearBtn=document.querySelector("#search-clear");const searchMask=document.querySelector("#search-mask");let searchStatus=0;function showSearchDialog(){if(searchStatus)return;searchMask.style.display="block";document.body.style.overflow="hidden";searchIpt.focus();searchStatus=1}function closeSearchDialog(){if(!searchStatus)return;searchMask.style.display="None";document.body.style.overflow="inherit";searchIpt.value="";searchStatus=0}function searchInitialize(e){fetch(e).then(e=>e.json()).then(e=>{const t=debounce(doSearch);searchBtn.style.display="flex";document.addEventListener("keydown",e=>{if((e.ctrlKey||e.metaKey)&&e.key=="i"){if(searchStatus)closeSearchDialog();else showSearchDialog()}if(e.key=="Escape")closeSearchDialog()});searchClearBtn.addEventListener("click",()=>{searchIpt.value="";clearResult()});searchBtn.addEventListener("click",()=>{showSearchDialog()});searchMask.addEventListener("click",e=>{if(e.target!==searchMask)return;closeSearchDialog()},true);searchIpt.addEventListener("input",t.bind(searchIpt,e))})}function clearResult(){searchResult.innerHTML=""}function doSearch(e){if(this.value.trim().length<=0)return clearResult();var t=this.value.trim().toLowerCase().split(/[\s\-]+/);const n=search(e,t);renderSearchResult(n,searchResult)}function search(e,t){const n=[];e.filter(e=>e.content).forEach(e=>{let r=e.title&&e.title.trim();r=r&&r.length>0?r:"Untitled";const s=e.content.trim().replace(/<[^>]+>/g,"");const a=[];t.forEach((e,t)=>{const n=r.toLowerCase().indexOf(e);const c=s.toLowerCase().indexOf(e);if(n<0&&c<0)return;a.push(Math.max(c,0))});if(a.length)n.push({url:e.url,content:trimeContent(a,s,t),title:r})});return n}function renderSearchResult(e,t){t.innerHTML="";if(!e||e.length<=0){t.innerHTML='<div class="search-result-empty">无结果</div>'}const r=document.createDocumentFragment();e.forEach(e=>{const t=document.createElement("a");t.className="search-result-item";t.href=e.url;const n=document.createElement("DIV");n.className="search-result__head";n.innerText=e.title;const c=document.createElement("DIV");c.className="search-result__body";e.content.forEach(e=>{const t=document.createElement("DIV");t.innerHTML=e;c.appendChild(t)});t.append(n,c);r.append(t)});t.appendChild(r)}function trimeContent(e,a,l,o=20){const t=/[\u4e00-\u9fa5]|\w+/dg;const i=[];let n;while((n=t.exec(a))!==null)i.push(n.indices[0]);return e.map(e=>{let t=binaryFind(i,e);const n=Math.max(0,t-10);const c=Math.min(o+n,i.length-1);const r=i[n][0];const s=i[c][1];l.forEach(e=>{a=a.slice(r,s).replace(new RegExp(e,"ig"),`<span class="search-keyword">${e}</span>`)});return a})}function binaryFind(e,t){let n=0,c=e.length-1,r=c;while(n<=c){if(t<e[r][0])c=r-1;else if(t>e[r][1])n=r+1;else return r;r=Math.floor((n+c)/2)}return r}function debounce(t,n=400){let c=null;return function(...e){clearTimeout(c);c=setTimeout(()=>{t.call(this,...e)},n)}}